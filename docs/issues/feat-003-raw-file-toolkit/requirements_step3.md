# feat-003 要求仕様書: Raw→MP4エンコード (Step 3)

対象: `dev/tutorials/13_raw_viewer/s13_raw_tool.py` （既存ツールにサブコマンド追加）
スコープ: Step 3（Raw→MP4エンコード）のみ

> **注意**
> - 本文は「要求仕様」のみを記述する。
> - 実装コードは一切含めない。

---

## 1. 目的と成功条件

### 1.1 目的

SRAWフォーマットのRawファイルからMP4動画ファイルを生成する。固定フレームレートのMP4に対して、Rawフレームのタイムスタンプを基にフレームを選択し、フレーム落ちがあっても自然な再生速度のMP4を出力する。

### 1.2 成功条件

1. セッションディレクトリ内の指定カメラのRawファイル群から1本のMP4ファイルを生成できる
2. MP4のフレームレートが指定値（固定fps）で出力される
3. フレーム落ちがあった場合、直前フレームの複製で補完される
4. Raw録画fpsがMP4 fpsより高い場合、タイムスタンプベースで適切にフレームが間引かれる

---

## 2. 入力データ仕様

Step 1 の requirements.md セクション2 と同一。

- セッションディレクトリ: `captures/YYYYMMDD-HHMMSS/`
- Rawファイル: `cam{serial}_{startframe:06d}.raw`（SRAWフォーマット）
- PixelFormat: BayerGR8（1 byte/pixel）のみ対応

---

## 3. 機能要件

### 3.1 サブコマンド: `encode`

**目的**: セッション内の指定カメラのRawファイルをMP4にエンコードする。

**入力**: セッションディレクトリパス + カメラシリアル番号

**処理概要**:
1. セッションディレクトリから指定シリアルのRawファイルを自動検出し、startframeの昇順で連結
2. 全Rawフレームのヘッダ情報（timestamp_ns）を読み込む
3. 指定fpsに基づいてMP4フレームタイムラインを生成し、各スロットに対応するRawフレームを選択
4. 選択されたフレームのペイロードをffmpegにパイプしてMP4エンコード

### 3.2 フレーム選択アルゴリズム

**タイムラインの構築**:
- MP4の先頭フレーム（t=0）は、Rawの先頭フレームのtimestamp_nsを基準とする
- MP4フレーム i の目標時刻: `t_target = t_first + i * (1_000_000_000 / fps)`
- MP4のフレーム数: 目標時刻がRawの最終フレームのtimestamp_nsを超えるまで

**各スロットのフレーム選択**:
- 目標時刻以前で最も近いRawフレームを選択する（floor方式）
- 同一のRawフレームが複数のMP4スロットに選択される場合がある（フレーム落ち補完）
- Raw録画fpsがMP4 fpsより高い場合、一部のRawフレームはスキップされる

### 3.3 ffmpegエンコード

**パイプライン**: RawのBayerGR8ペイロードをffmpegのstdinにパイプする。ffmpegがデベイヤーとMP4エンコードを行う。

**ffmpegオプション（固定）**:
- 入力: `-f rawvideo -pix_fmt bayer_grbg8 -s {width}x{height} -framerate {fps}`
- 変換: `-vf format=yuv420p`
- エンコーダ: `-c:v hevc_nvenc -b:v 2200k -maxrate 2200k -bufsize 4400k -preset p4`

### 3.4 出力

**出力先**: セッションディレクトリ（Rawファイルと同じディレクトリ）

**ファイル名**: `cam{serial}.mp4`
- 例: `captures/20260210-153000/cam05520125.mp4`

**同名ファイルが存在する場合**: エラーとして終了する（上書きしない）

### 3.5 コンソール出力

エンコードの進捗と結果を表示する。

**出力例**:
```
=== Encode: captures/20260210-153000/ cam05520125 ===
  Raw files: cam05520125_000000.raw (1000 frames), cam05520125_001000.raw (500 frames)
  Total raw frames: 1500
  Time span: 50.000 s
  MP4 fps: 30
  MP4 frames: 1500 (0 duplicated, 0 skipped)
  Output: captures/20260210-153000/cam05520125.mp4
  Encoding...
  Done.
```

**フレーム落ち補完時の出力例**:
```
  MP4 fps: 30
  MP4 frames: 1500 (3 duplicated, 0 skipped)
```

---

## 4. CLI インターフェース

### 4.1 コマンド体系

```
python s13_raw_tool.py encode <session_dir> --serial <serial> [--fps 30]
```

### 4.2 引数

| 引数 | 型 | 必須 | デフォルト | 説明 |
|------|-----|------|-----------|------|
| `session_dir` | str | Yes | — | セッションディレクトリパス |
| `--serial` | str | Yes | — | カメラシリアル番号 |
| `--fps` | int | No | 30 | MP4の出力フレームレート |

### 4.3 終了コード

| コード | 意味 |
|-------|------|
| 0 | 正常終了 |
| 1 | エンコード失敗（ffmpegエラー等） |
| 2 | 入力エラー（ディレクトリ不在、Rawファイルなし、同名MP4既存等） |

---

## 5. エラーハンドリング

| 状況 | 対応 | 終了コード |
|------|------|-----------|
| セッションディレクトリが存在しない | エラーメッセージ出力 | 2 |
| 指定シリアルのRawファイルが見つからない | エラーメッセージ出力 | 2 |
| pixel_formatがBayerGR8以外 | エラーメッセージ出力 | 2 |
| 出力先に同名MP4が既に存在する | エラーメッセージ出力 | 2 |
| ffmpegが見つからない | エラーメッセージ出力 | 2 |
| ffmpegが異常終了 | エラーメッセージ出力（stderrを表示） | 1 |
| Rawフレーム数が0 | エラーメッセージ出力 | 2 |

---

## 6. 非要件

- 可変フレームレート（VFR）方式は使用しない
- BayerGR8以外のピクセルフォーマットには対応しない
- ffmpegエンコードオプション（ビットレート、プリセット等）のCLI変更は提供しない
- 複数カメラの一括エンコードは提供しない（1回の実行で1カメラ分）
- 音声トラックは含まない
- エンコード進捗のプログレスバー表示は提供しない

---

## 7. 依存関係

- Python 3.x 標準ライブラリ（Step 1と同一）
- **ffmpeg**: 外部コマンドとして呼び出し。`hevc_nvenc` エンコーダが使用可能であること（NVIDIA GPU必須）
- OpenCVは不要（ffmpegがデベイヤー処理を行う）
