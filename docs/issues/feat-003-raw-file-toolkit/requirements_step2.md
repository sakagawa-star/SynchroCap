# feat-003 要求仕様書: Rawフレームビューワー (Step 2)

対象: `dev/tutorials/13_raw_viewer/s13_raw_tool.py` （既存ツールにサブコマンド追加）
スコープ: Step 2（静止画ビューワー）のみ

> **注意**
> - 本文は「要求仕様」のみを記述する。
> - 実装コードは一切含めない。
> - Step 3（MP4エンコード）は本仕様の対象外。

---

## 1. 目的と成功条件

### 1.1 目的

Rawファイルに映像が正しく保存されているかを、目視でサンプリングチェックするためのビューワーを提供する。

### 1.2 成功条件

1. Rawファイルの先頭フレームをデベイヤー処理してカラー画像として表示できる
2. 任意のフレーム番号を指定して表示できる
3. 表示中の画像をPNGファイルとして保存できる

---

## 2. 入力データ仕様

Step 1 の requirements.md セクション2 と同一。

- Rawファイル: SRAWフォーマット（FileHeader + FrameHeader + Payload の繰り返し）
- PixelFormat: BayerGR8（1 byte/pixel）のみ対応

---

## 3. 機能要件

### 3.1 サブコマンド: `view`

**目的**: Rawファイルから指定フレームを読み込み、デベイヤー処理したカラー画像をウィンドウ表示する。

**入力**: Rawファイルパス（1ファイル指定）

**デフォルト動作**: 先頭フレーム（frame_index=0）を表示する。

**オプション**:
- `--frame N`: 表示するフレームのインデックス（ファイル内での0始まり位置）

**画像処理**:
- BayerGR8のRawペイロードをOpenCVでデベイヤー（デモザイク）し、BGRカラー画像に変換する

**ビューワー操作**:
- ウィンドウにカラー画像を表示する
- `s` キー: 表示中の画像をPNGファイルとして保存する
- `q` キーまたはウィンドウ閉じ: ビューワーを終了する

**PNG保存**:
- 保存先: Rawファイルと同じディレクトリ
- ファイル名: `{rawファイル名のステム}_frame{index:06d}.png`
  - 例: `cam05520125_000000_frame000042.png`
- 保存完了時にコンソールにパスを表示する

**出力例（コンソール）**:
```
=== View: cam05520125_000000.raw ===
  FileHeader: 1920x1080 BayerGR8
  Frame: index=42, timestamp_ns=1234567890123456789
  Showing frame 42 (press 's' to save, 'q' to quit)
  Saved: /path/to/cam05520125_000000_frame000042.png
```

---

## 4. CLI インターフェース

### 4.1 コマンド体系

```
python s13_raw_tool.py view <raw_file> [--frame N]
```

### 4.2 引数

| 引数 | 型 | 必須 | デフォルト | 説明 |
|------|-----|------|-----------|------|
| `raw_file` | str | Yes | — | Rawファイルパス |
| `--frame` | int | No | 0 | 表示するフレームインデックス（ファイル内位置） |

### 4.3 終了コード

| コード | 意味 |
|-------|------|
| 0 | 正常終了 |
| 2 | 入力エラー（ファイル不在、フレーム範囲外等） |

---

## 5. エラーハンドリング

| 状況 | 対応 | 終了コード |
|------|------|-----------|
| ファイルが存在しない | エラーメッセージ出力 | 2 |
| `--frame` がファイル内フレーム数を超過 | エラーメッセージ（総フレーム数を表示） | 2 |
| pixel_formatがBayerGR8以外 | エラーメッセージ（未対応フォーマット） | 2 |
| PNG保存失敗 | WARNINGをコンソール出力、ビューワーは継続 | — |

---

## 6. 非要件

- BayerGR8以外のピクセルフォーマットは対応しない
- 分割Rawファイルを跨いだフレーム指定は行わない（1ファイル単位の操作）
- ズーム・パン等の画像操作は提供しない
- 複数フレームの連続表示（スライドショー）は提供しない
- ヘッドレス（ビューワーなし）でのPNG保存は提供しない

---

## 7. 依存関係

- Python 3.x 標準ライブラリ（Step 1と同一）
- **opencv-python** (`cv2`): デベイヤー処理 (`cv2.cvtColor`) およびビューワー表示 (`cv2.imshow`)
