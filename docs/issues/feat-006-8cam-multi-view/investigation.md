# feat-006: フレーム落ち原因調査

## 現象

### 現象A: 200秒録画でのフレーム落ち

- 8カメラ Raw録画（1920x1080, 30fps, BayerGR8, 200秒）
- 約5000フレーム（約167秒経過）付近から全8カメラで同時にフレーム落ちが頻発
- ドロップパターン: ほぼ全てが1フレーム飛び（dt=66.666ms）、一部2フレーム飛び
- 各カメラのドロップ数: 15〜17回

### 現象B: 現象A発生後の30秒録画での末尾欠損

- 現象A発生後に録画時間を30秒に短縮して実行
- フレームの途中が抜けるのではなく、末尾の約20フレームが記録されない
- 現象A発生前は30秒録画で問題なし

## 前提情報

| 項目 | 値 |
|------|-----|
| 1フレームのデータ量 | 1920 × 1080 × 1 byte = 2,073,600 bytes ≈ 2.07 MB |
| 1カメラのデータレート | 2,073,600 × 30 = 62,208,000 bytes/sec ≈ 497.7 Mbps |
| 8カメラ合計データレート | ≈ 497 MB/s |
| QueueSinkバッファ数 | 500（約16.7秒分/カメラ） |

## 原因: ストレージ書き込み帯域の恒常的な不足

### iostat分析結果

録画中のT5 EVO（sdb）の書き込み速度を `iostat -xm sdb 1` で監視した。

| 項目 | 値 |
|------|-----|
| 要求書き込み速度（8カメラ Raw） | ~497 MB/s |
| T5 EVOの実際の書き込み速度 | ~430 MB/s（安定） |
| **帯域不足** | **~67 MB/s（常時13%不足）** |

- ディスクI/Oの劣化（速度低下・レイテンシ悪化）は200秒間を通じて**一切なし**
- T5 EVOは録画中430 MB/sを安定維持
- 5 Gbpsはインタフェースの理論値であり、実効書き込み速度は430 MB/s
- SLCキャッシュ枯渇は起きていない（速度は一貫して安定）

### フレーム落ちのメカニズム

```
T=0s〜167s:  書き込みが追いつかない分をOSバッファ(ページキャッシュ)が吸収
             67 MB/s × 167秒 ≈ 11.2 GB のバッファ蓄積
T=167s:      OSバッファが限界に到達 → write()がブロック → フレームドロップ開始
T=167s〜200s: バッファ飽和状態が継続し、定常的にドロップ
```

### 仮説の検証結果

| 仮説 | 結果 |
|------|------|
| 仮説1: SLCキャッシュ枯渇による速度低下 | **否定** — 速度低下なし |
| 仮説2: OSバッファ飽和 | **確定** — 帯域不足分がバッファに蓄積し飽和 |
| 仮説3: QueueSinkオーバーフロー | 仮説2の二次的結果として発生した可能性あり |
| 仮説4: カメラ/ドライバの残存状態 | 未検証（現象Bについて） |

## 対応方針

### 8カメラ対応の制約

- T5 EVO単体では8カメラRaw録画（~497 MB/s）に対して帯域不足（430 MB/s）
- T5 EVOで安全に運用可能な台数: **6台**（~373 MB/s < 430 MB/s）
- NVMe（nvme0n1）なら8カメラでも帯域は十分だが、空き容量の制約あり

### 決定事項

1. **アプリの設定上は8台録画可能な状態を維持する**
2. **当面はT5 EVOに6台で運用・検証を続ける**
3. **検証テスト**: 200秒 × 8カメラ録画をnvme0n1に保存し、フレーム落ちがないことを確認する
4. 将来的に書き込み先の複数ディスク分散を検討する可能性あるが、今は対応しない

## 検証テスト

### テスト: 8カメラ × 200秒 → nvme0n1

- 目的: ストレージ帯域が原因であることの確定的な裏付け
- 保存先: nvme0n1上のディレクトリ
- 期待結果: フレーム落ちなし
- **ステータス: PASS**
- 結果:
  - フレーム落ちなし
  - s13_raw_tool.py validate: 全カメラ正常
  - 同期確認: 0フレーム目・6000フレーム目で全カメラ同一映像を確認
- **結論: ストレージ帯域が原因であることが確定**

## エビデンス

- [log_check_csv](log_check_csv) — 8カメラ200秒録画のCSV連続性チェック結果
- [iostat_log.txt](iostat_log.txt) — 録画中のiostat監視ログ
